# Standalone Dockerfile for Monthly Excel Writer
FROM python:3.11-slim

# Install system dependencies including cron
RUN apt-get update && apt-get install -y \
    cron \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Set timezone to Slovakia

# Set timezone to Slovakia
ENV DB_HOST=icls-postgres \
    DB_PORT=5432 \
    POSTGRES_USER=postgres \
    POSTGRES_PASS=admin123 \
    POSTGRES_DB=postgres \
    TZ=Europe/Bratislava

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Set working directory
WORKDIR /app

# Install Python dependencies for Excel writer
RUN pip install --no-cache-dir \
    psycopg2-binary==2.9.7 \
    openpyxl==3.1.2 \
    pytz==2023.3

# Copy only the Excel writer script
COPY monthly_excel_writer.py .

# Create reports directory
RUN mkdir -p /app/reports

# Create cron job for monthly Excel report generation
# Run on 1st of every month at 00:05 (5 minutes past midnight) Slovakia time
RUN echo "5 0 1 * * cd /app && /usr/local/bin/python monthly_excel_writer.py >> /var/log/cron.log 2>&1" > /etc/cron.d/monthly-excel-reports

# Set proper permissions for cron job
RUN chmod 0644 /etc/cron.d/monthly-excel-reports
RUN crontab /etc/cron.d/monthly-excel-reports

# Create log file for cron
RUN touch /var/log/cron.log

# Create startup script that starts cron and keeps container running
RUN echo '#!/bin/bash\n\
echo "Starting Monthly Excel Writer Service..."\n\
echo "Timezone: $(date +%Z)"\n\
echo "Current time: $(date)"\n\
echo "Next monthly report: 1st of next month at 00:05"\n\
\n\
# Start cron daemon\n\
echo "Starting cron daemon..."\n\
cron\n\
\n\
tail -f /var/log/cron.log\n\
' > /app/start-excel-writer.sh

# Make startup script executable
RUN chmod +x /app/start-excel-writer.sh

# Expose volume for reports
VOLUME ["/app/reports"]

# Health check - verify cron is running
HEALTHCHECK --interval=60s --timeout=10s --start-period=5s --retries=3 \
  CMD pgrep cron > /dev/null || exit 1

# Start the service
CMD ["/app/start-excel-writer.sh"] 