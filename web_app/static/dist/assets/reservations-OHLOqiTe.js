const A=document.getElementById("close-modal"),g=document.getElementById("modal-lease-details"),D=document.getElementById("modal-status"),P=document.getElementById("close-modal-status"),u=document.getElementById("modal-backdrop"),L=document.getElementById("modal-inner"),h=document.getElementById("modal-return-car"),R=document.getElementById("finish-reservation-button"),$=document.getElementById("scrap-reservation-button"),M=document.getElementById("return-car-button"),b=document.getElementById("stop-return-button"),x=document.getElementById("filter"),f=document.getElementById("user-list"),z=document.getElementById("car-list"),T=document.getElementById("status-true"),_=document.getElementById("status-false"),S=document.getElementById("timeof"),C=document.getElementById("timeto"),B=document.getElementById("car-damaged"),I=document.getElementById("car-damaged-params"),O=document.getElementById("car-collision");let j,r;function k(){fetch("/get_session_data",{method:"POST"}).then(n=>n.json()).then(n=>{r=n.role,username=n.username;let t;r==="manager"?t=JSON.stringify({car_name:z.value,email:f.value,timeof:S.value,timeto:C.value,istrue:T.checked,isfalse:_.checked}):t=JSON.stringify({car_name:"",email:username,timeof:S.value,timeto:C.value,istrue:T.checked,isfalse:_.checked}),fetch("/get_user_leases",{method:"POST",headers:{"Content-Type":"application/json"},body:t}).then(e=>e.json()).then(e=>{if(!e)document.getElementById("default-message").style.display="block";else if(r==="manager")if(f.value==="")E(e);else{const o=e.filter(a=>a.email===f.value);E(o)}else E(e)})})}function E(n){const t=document.getElementById("card-container");t.innerHTML="";for(let e of n){const o=new Intl.DateTimeFormat("sk-SK",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});let a=e.time_from.replace(" ","T"),l=e.time_to.replace(" ","T");a=new Date(a),l=new Date(l),a=o.format(a),l=o.format(l);const c=document.createElement("div");if(c.classList.add("card"),c.onclick=function(){F(e)},c.id="card",e.status===!1)c.style.backgroundColor="#bc2026";else if(e.status===!0){const s=new Date;s.setHours(s.getHours()+2),s.toISOString().replace("T"," ").split(".")[0]<e.time_from?c.style.backgroundColor="orange":c.style.backgroundColor="green"}const i=document.createElement("img");i.src=e.url,i.alt=e.car_name,c.appendChild(i);const d=document.createElement("h2");d.innerText=e.car_name,c.appendChild(d);const y=document.createElement("h3");y.innerText=e.spz,c.appendChild(y);const p=document.createElement("p");p.innerText=`Od: ${a}`,c.appendChild(p);const m=document.createElement("p");if(m.innerText=`Do: ${l}`,c.appendChild(m),r==="manager"){const s=document.createElement("p");s.innerText=`Objednal: ${e.email}`,c.appendChild(s)}t.appendChild(c)}}function N(){function n(){return new Date().toISOString().replace("T"," ").replace("Z","").split(".")[0]}const t=document.getElementById("car-location").value;let e=document.getElementById("car-damaged").checked,o=document.getElementById("car-dirty").checked,a=document.getElementById("car-int-dmg").checked,l=document.getElementById("car-ext-dmg").checked,c=document.getElementById("car-collision").checked;const i=document.getElementById("note").value;fetch("/get_session_data",{method:"POST"}).then(d=>d.json()).then(d=>{let y=d.token;const p=n(),m={id_lease:j,time_of_return:p,note:i,location:t,damaged:e,dirty:o,int_damage:a,ext_damage:l,collision:c};console.log(JSON.stringify(m)),fetch("/return_car",{method:"POST",headers:{Authorization:"Bearer "+y,"Content-Type":"application/json"},body:JSON.stringify(m)}).then(s=>s.json()).then(s=>{v(),h.style.display="none",w(s),k()}).catch(s=>console.error("Error fetching car details:",s))})}function q(){let n=b.value;fetch("/get_session_data",{method:"POST"}).then(t=>t.json()).then(t=>{let e=t.token,o;t.role==="user"?o=t.username:o=document.getElementById("modal-user").innerHTML.split(">")[1],fetch("/cancel_lease",{method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({car_name:n,recipient:o})}).then(a=>a.json()).then(a=>{v(),w(a),k()})})}function F(n){j=n.lease_id,n.status===!1?(document.getElementById("finish-reservation-button").style.display="none",document.getElementById("scrap-reservation-button").style.display="none"):(document.getElementById("finish-reservation-button").style.display="block",document.getElementById("scrap-reservation-button").style.display="block");const t=new Intl.DateTimeFormat("sk-SK",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});let e=n.time_from.replace(" ","T"),o=n.time_to.replace(" ","T");e=new Date(e),o=new Date(o),e=t.format(e),o=t.format(o),document.getElementById("modal-car-name").innerText=`${n.car_name}`,document.getElementById("modal-time-from").innerText=`Rezervované od:
${e}`,document.getElementById("modal-time-to").innerText=`Rezervovaná do:
${o}`,document.getElementById("modal-spz").innerText=`SPZ auta:
${n.spz}`,document.getElementById("modal-state").innerText=`Status:
${n.status===!0?"Aktívny":"Ukončený"}`,b.value=n.car_name,r==="manager"&&(document.getElementById("modal-user").innerText=`Objednal:
${n.email}`),g.style.display="block",u.style.display="block"}function v(){g.style.display="none",h.style.display="none",u.style.display="none"}A.addEventListener("click",function(){g.style.display="none",h.style.display="none",u.style.display="none",document.querySelectorAll('#car-damaged-params input[type="checkbox"]').forEach(t=>t.checked=!1)});R.addEventListener("click",()=>{g.style.display="none",h.style.display="block"});$.addEventListener("click",()=>{q()});M.addEventListener("click",()=>{N()});b.addEventListener("click",()=>{const n=document.querySelectorAll('#car-damaged-params input[type="checkbox"]');B.checked=!1,I.style.display="none",n.forEach(t=>t.checked=!1),v()});B.addEventListener("click",()=>{B.checked===!0?I.style.display="block":(I.style.display="none",document.querySelectorAll('#car-damaged-params input[type="checkbox"]').forEach(e=>{e.checked=!1}))});O.addEventListener("click",()=>{O.checked===!0?document.querySelectorAll('#car-damaged-params input[type="checkbox"]').forEach(e=>{e.checked=!0}):document.querySelectorAll('#car-damaged-params input[type="checkbox"]').forEach(e=>{e.checked=!1})});function w(n){let t=!1;const e=n.status,o=n.cancelled,a=document.querySelector("#modal-status #modal-inner h2"),l=document.querySelector("#modal-status #modal-inner p");e==="returned"&&t===!1?(a.textContent="Úspech :)",l.textContent="Auto bolo úspešne vtárené!",t=!0):o===!0&&t===!1&&(a.textContent="Úspech :)",l.textContent="Rezervácia bola zrušená!",t=!0),!e&&t===!1?(a.textContent="Neúspech :(",l.textContent="Auto sa nepodarilo vrátiť! Obnovte stránku a skúste to znova."):!o&&t===!1&&(a.textContent="Neúspech :(",l.textContent="Rezerváciu sa nepodarilo zrušiť! Obnovte stránku a skúste to znova."),D.style.display="block",L.style.display="block",u.style.display="block"}x!==null&&x.addEventListener("click",function(){k()});P.addEventListener("click",function(){u.style.display="none",D.style.display="none"});document.addEventListener("DOMContentLoaded",()=>{k(),L.style.display="none",r==="manager"&&(fetch("get_cars",{method:"POST"}).then(n=>n.json()).then(n=>{for(let t of n){const e=new Option(t[0],t[0]);z.add(e)}}),fetch("get_users",{method:"POST"}).then(n=>n.json()).then(n=>{for(let t of n){const e=new Option(t.email,t.email);f.add(e)}}))});
